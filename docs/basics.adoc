= Get to know the basics of Enonic development
include::variables.adoc[]

In this {document} we'll introduce the fundamental concepts of Enonic XP development. You'll get a brief introduction to the Enonic command line interface (CLI), XP _sandboxes_, starter kits, and building and deploying apps on XP. By the end of the {document} you'll have spun up an instance of XP and deployed an app to it.

There's lots to cover, so let's get to it, shall we?

== The Enonic CLI

NOTE: If you haven't installed the Enonic CLI yet, be sure to check out the xref:setup#_installing_the_enonic_cli[installation instructions in the previous {document}].

The Enonic command line interface is a powerful tool, built specifically for the Enonic platform. The CLI allows you to interact with XP instances and deploy and develop apps.

To see all available options, run the following command in your terminal:

    enonic

It should output something that looks a bit like this:

.Main help page
----
Enonic CLI v.1.5.1
Manage XP instances, home folders and projects

USAGE:
   enonic [global options] command [command options] [arguments...]

COMMANDS:
     snapshot  Create and restore snapshots
     dump      Dump and load complete repositories
     export    Export data from a given repository, branch and content path.
     import    Import data from a named export.
     app       Install, stop and start applications
     repo      Tune and manage repositories
     cms       CMS commands
     system    System commands
     latest    Check for latest version
     vacuum    Removes old version history and segments from content storage
     help, h   Shows a list of commands or help for one command

PROJECT COMMANDS:
     sandbox  Manage XP development instances
     project  Manage XP development projects

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version
----

If you want to know more about how to use one of the subcommands, you can use the `help` subcommand. For instance, if you want to know more about the `sandbox` subcommand, you can run

    enonic sandbox help

This should result in something like the following being printed to your screen:

.Sandbox help page
----
NAME:
   Enonic CLI sandbox - Manage XP development instances

USAGE:
   Enonic CLI sandbox [global options] command [command options] [arguments...]

VERSION:
   1.5.1

COMMANDS:
     list, ls         List all sandboxes
     start            Start the sandbox.
     stop             Stop the sandbox started in detached mode.
     create           Create a new sandbox.
     delete, del, rm  Delete a sandbox
     upgrade, up      Upgrades the distribution version.

GLOBAL OPTIONS:
   --help, -h  show help
----


== Sandboxes

When talking about _sandboxes_, we're actually talking about local instances of Enonic XP. Having a local (and running) instance of XP is essential for an effective development workflow.

Let's create a new sandbox by using the CLI. When you create a new sandbox, the CLI will present you with a few questions for configuring the sandbox, such as the sandbox name. To respond to a question, type in the desired response and press kbd:[enter].

[NOTE]
====
If you press kbd:[enter] without entering a response, the CLI will use the default response. The default response to a question is listed in parentheses after the question. For instance, the prompt for a sandbox name might look like this:

    ? Sandbox name (Sandbox1)

Here, `Sandbox1` is the default response.
====

Run the following command to get started:

    enonic sandbox create

When prompted, give your sandbox the name: `tutorial`. Next, when asked which XP distribution you want, use the latest one (at the top of the list).

The CLI will download the Enonic XP SDK distribution for your operating system and link it to the sandbox.

.Creating a sandbox
----
? Sandbox name: tutorial
? Enonic XP distribution: mac-sdk-7.2.0
Downloading distro [===================>--------------------------------]  37.64%
----

Once completed, we can use the CLI to start the sandbox:

    enonic sandbox start

Optionally, you can run the sandbox with the `--dev` flag. This makes the sandbox automatically pick up certain changes to deployed applications, including most of the work we'll be doing in the coming {document}s. Read https://developer.enonic.com/docs/xp/stable/apps/build-system#development_mode[more about dev mode] in the reference docs. With the flag, the command would be

  enonic sandbox start --dev

If you're in an XP project directory, this will start the sandbox belonging to this project automatically. Otherwise, you'll have to select which sandbox to start. If that's the case, choose the `tutorial` sandbox and watch it boot up in your terminal. The boot output should look something like this, but with values adjusted for your system.

.Output when booting sandbox
----
                         _____
____________________________(_)______   ____  _________
_  _ \_  __ \  __ \_  __ \_  /_  ___/   __  |/_/__  __ \
/  __/  / / / /_/ /  / / /  / / /__     __>  < __  /_/ /
\___//_/ /_/\____//_/ /_//_/  \___/     /_/|_| _  .___/
                                               /_/

# Enonic XP 7.6.1
# Built on 2021-02-25T14:26:46Z (hash = 6359021fdb52fda156e39465d824153c915d903c, branch = 7.6)
# OpenJDK 64-Bit Server VM 11.0.10 (AdoptOpenJDK)
# Linux 5.4.108 (amd64)
# Install directory is $HOME/.enonic/distributions/enonic-xp-linux-sdk-7.6.1
# Home directory is $HOME/.enonic/sandboxes/tutorial/home
[...]
----


The initial output gives you a lot of information about this sandbox, including its home and install directories. We won't be needing them in this {document}, but knowing where you can find these details might be useful at a later time.

After the sandbox has started, you should see something like the following output in your terminal:

----
[...] - Started xp@523d2774{HTTP/1.1,[http/1.1]}{0.0.0.0:8080}
[...] - Started api@22bce39c{HTTP/1.1,[http/1.1]}{0.0.0.0:4848}
[...] - Started status@37f8a3e8{HTTP/1.1,[http/1.1]}{0.0.0.0:2609}
[...] - Started @12314ms
[...] - Started Jetty
[...] - Listening on ports [8080](xp), [4848](management) and [2609](monitoring)
[...] - Searching for installed applications
[...] - Found [0] installed applications
[...] - Started Enonic XP in 11207 ms
----

This means that your local XP instance is up and running and ready to serve requests. The instance exposes the following ports:

* *8080*: Web
* *4848*: Management API (Used by the CLI when running commands against this XP instance)
* *2609*: Monitoring API (Used for metrics and instance info)

NOTE: To stop your sandbox, press kbd:[ctrl-c] in the terminal hosting the process. You can also run `enonic sandbox stop` in a different terminal instance.

=== Troubleshooting

If you have problems booting the sandbox, it may be that one or more of the ports used by XP are already in use. The command should warn you if something doesn't work right. It'll do this in one of two ways:

. If the CLI checks for the availability of some ports when starting up. If one of these ports isn't available, the CLI will abort with a message like this:

----
Port 8080 is not available, stop the app using it first!
----

. For ports where the CLI doesn't check for availability before starting, you might get an exception in the boot log. This is usually identifiable by a printed stack trace in your logs. Here's an example from what happens if port 4848 isn't available. The `[...]` replaces most of the stack trace for legibility reasons.

----
2021-04-06 11:24:01,168 ERROR c.e.xp.web.jetty.impl.JettyActivator - bundle com.enonic.xp.web.jetty:7.6.1 (80)[com.enonic.xp.web.jetty.impl.JettyActivator(171)] : The activate method has thrown an exception
org.apache.felix.log.LogException: java.io.IOException: Failed to bind to 0.0.0.0/0.0.0.0:4848
	at org.eclipse.jetty.server.ServerConnector.openAcceptChannel(ServerConnector.java:349)
	at org.eclipse.jetty.server.ServerConnector.open(ServerConnector.java:310)
[...]
Caused by: java.net.BindException: Address already in use
	at java.base/sun.nio.ch.Net.bind0(Native Method)
	at java.base/sun.nio.ch.Net.bind(Net.java:455)
	at java.base/sun.nio.ch.Net.bind(Net.java:447)
	at java.base/sun.nio.ch.ServerSocketChannelImpl.bind(ServerSocketChannelImpl.java:227)
	at java.base/sun.nio.ch.ServerSocketAdaptor.bind(ServerSocketAdaptor.java:80)
	at org.eclipse.jetty.server.ServerConnector.openAcceptChannel(ServerConnector.java:345)
	... 78 common frames omitted
----

If some ports are unavailable, you'll have to find out what programs are using those ports and then shut those programs down. How you find open ports varies from operating system to operating system, but if you're unsure about how to do it on your OS, check out the appropriate guide for https://www.cyberciti.biz/faq/unix-linux-check-if-port-is-in-use-command/[Linux], https://www.micahsmith.com/blog/2019/09/find-ports-in-use-on-macos/[macOS], or https://www.howtogeek.com/howto/28609/how-can-i-tell-what-is-listening-on-a-tcpip-port-in-windows/[Windows].

== Admin console

With your sandbox running, lets have a look at XP's admin console.
Point your browser to http://localhost:8080.

You should see the default XP login screen:

.The XP login screen
image::xp-login.png[The XP login screen.]


From the login screen, click "log in without a user". When working on a local development environment, we don't need to concern ourselves with users and administrators, so we'll get back to that in xref:chapter#_section[chapter X]. (TODO: do we? we should cover this at some point.)

After signing in, you will be greeted by the XP welcome tour. Complete the tour and install the applications listed in the final step. You'll need some of them later in this tutorial.

.The first step of the welcome tour
image::xp-tour-1.png[A popup describing the tools and navigation system of Enonic XP., width=890]

.The second step of the welcome tour
image::xp-tour-2.png[A description of XP applications and the Enonic Market., width=890]

.The final step of the welcome tour
image::xp-tour-3.png["A prompt to install a set of applications from the Enonic Market including Content Studio, Live Trace, and Data Toolbox.", width=890]

NOTE: If the welcome tour does not start automatically or if you want to take it again, you can always click the "XP Tour" icon on the home screen to start it manually.

== Projects and starters

Creating a project from scratch can be a daunting task for any system you're not familiar with. To make things easier for you, Enonic provides a range of different project templates (known as _starters_). We'll make use of these throughout this tutorial.

NOTE: The complete list of starters can be found on https://market.enonic.com/starters[the Enonic Market].

For our first project, we'll use the "Headless CMS" starter. This starter is tailored to start creating your own headless content API, but is fairly minimal. We'll use this to familiarize ourselves with how an XP app is structured and how to upload an app to XP.

Here's how to use the CLI to create your first app.

. Launch a new terminal
. When creating a project via the CLI, it creates a folder in your current working directory, so navigate to wherever you want your project to reside. Then, run this command:

    enonic project create

. Choose `Headless CMS starter` from the list of available starters.
. When prompted enter the name, press kbd:[enter] to accept the default.
+
NOTE: Project names matter. XP does not support running two apps with the same name within a single instance.
+
. Use the default values for destination folder and version. If the destination folder already exists, you'll have to either choose another name for the folder or remove or rename the folder that already exists.
. When prompted to select a sandbox, choose the  `tutorial` sandbox we created previously.
. Finally, press kbd:[enter] to skip opening the starter documentation. If you answer yes, the documentation for this starter will open in your browser. This is useful if you're using a starter you're not familiar with (and aren't following a guide).

If you used the default values as specified in the steps, a directory named `{project-name}/` should have been created during the process. If you used a different project name or project directory name, your directory will have a different name.

The project directory contains a fairly minimal XP application. The most relevant parts of the directory are:

.Essential XP project structure
[source,files]
----
build.gradle <--1-->
gradle.properties <--2-->
src/
  main/
    resources/ <!--3-->
----

<1> The main build file for defining dependencies and more build-related details.
<2> Contains the standard project settings, as defined by the CLI.
<3> The main project folder. JavaScript code and assets are placed here.

== Building and deploying

Now that we've set up a project, let's see how we build (or _compile_) the project and then how we deploy it to our XP instance. Again, the CLI is key to making this process as smooth as possible.

Here are the steps we need to take:

. Change to the project directory:
+
[subs="attributes"]
----
cd {project-name}
----
+
. If your sandbox isn't already running, start it by using this command:
+
  enonic sandbox start
+
This will start the sandbox belonging to the current project directory.

. Start the build with Enonic CLI:

    enonic project build

While building your project, the CLI will print what it's doing to your terminal. It will look something like this:

.Sample output from build process
----
Building in sandbox 'tutorial'...
Starting a Gradle Daemon (subsequent builds will be faster)

BUILD SUCCESSFUL in 5s
3 actionable tasks: 3 executed
----

After the build has finished, you'll have a new file in your project directory, located under the `build/libs` subdirectory. Assuming you have used the default name, it'll be located at `build/libs/{project-name}.jar` when at the project root. This file is the executable file that contains your application.

To deploy the app to the sandbox, use the CLI again. From the project root folder, run:

    enonic project deploy

This copies the application file to your sandbox's `home/deploy/` folder. XP picks up on this automatically and starts the app for you.

NOTE: The `enonic project deploy` command will build your project if you have made changes since the last build or haven't built yet. It will also ask whether you want to start the appropriate sandbox if it isn't already running.

To confirm that your application was started correctly, you can look at the logs in the sandbox's terminal window. They should say something like this:

.Application output
[subs="attributes"]
----
[...] - Local application [{project-name-full}] installed successfully
[...] - Application [{project-name-full}] started successfully
----

You can also verify that the application was installed correctly by using the admin console ({xp-url}): Open the "Applications" app from the main launcher panel and look for your application in the list.


.The applications list with the headless starter installed
image::applications-headless.png["The applications list with a few applications installed. Also shows application details, such as content install time, version, and required XP system version for the selected application."]

You've now successfully built and deployed your first Enonic XP application. Well done! Now let's look at creating content.

=== Changing the display name of an application
You might have noticed that the application we created was listed as "Headless Starter" in the applications list above. What if you wanted to change that to something more descriptive? To do that, we can head to the `gradle.properties` file in the project's root directory. Change the `appDisplayName` to whatever you want it to display.

Similarly, you can change your application's description to something more appropriate `src/main/resources/application.xml` by replacing the stock text inside of the `description` element.

=== What if the application doesn't show up?

If the application doesn't show up under the Applications tab in XP after you've run `enonic project deploy`, check the logs (for the build first, and then for XP) for errors. The build might have failed or something may have gone wrong when deploying.

If the build works, but nothing shows up in the Applications tab, make sure you're running the right sandbox. The CLI deploys to the sandbox specified in the project's `.enonic` file (in the project directory root). This has to match the name of the sandbox that's running.

If you've checked that you're running the right sandbox and that the build succeeds, but you're still not seeing the application, you can do a manual deploy. The project build result is available in the `build/libs` directory of the project. You can copy this `.jar` file to the sandbox's `home/deploy` directory. This will make XP pick it up. If you've used the suggested names in the steps above (and the default directories for XP configuration), this command will move the file for you on Unix systems when run from the project root:

[subs="attributes"]
  mv build/libs/{project-name}.jar ~/.enonic/sandboxes/tutorial/home/deploy/

NOTE: If you have to deploy manually when going through this tutorial, please get in touch on https://discuss.enonic.com[discuss.enonic.com] so we can improve the documentation and the process.


== Summary

In this {document} we've had our first glimpse at using the Enonic CLI,  we've had a little tour of the XP Admin console and installed some XP apps, and we've even created and deployed our first application; not bad at all!

== Next

In the next {document} we'll start adding content to the app we just deployed and see how we get a GraphQL API automatically generated for it. We'll keep working on the app over the next couple {document}s, so keep it close!
